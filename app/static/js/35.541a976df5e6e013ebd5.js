webpackJsonp([35],{kP1p:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n={name:"merge_img",data:function(){return{winH:window.innerHeight,winW:window.innerWidth,startPoint:{point1:{x:0,y:0},point2:{x:0,y:0}},endPoint:{point1:{x:0,y:0},point2:{x:0,y:0}},imgList:[],mergeBtnShow:!1,bgShow:!1,canMove:!1,moveTimer:"",zIndexNum:2,imgScale:0,czIndex:-1,bgType:"color",bgColor:null,showCanvasImg:!1,canvasImgSrc:"",isCreateImg:!1,delTimer:"",delNum:0,fontShow:!1,mergeText:"",mergeFSize:"",mergeFColor:"black",mergeTextArr:[]}},mounted:function(){this.isApp?this.winH=window.innerHeight-api.safeArea.top:this.winH=window.innerHeight},methods:{changeBtnShow:function(){this.mergeBtnShow=!this.mergeBtnShow},changeBgShow:function(){this.bgShow=!this.bgShow,this.mergeBtnShow=!1},closeBgShow:function(){this.bgShow=!1},getImgInfo:function(t){var e=this,i=t.imgArr,n=t.curIndex,o=t.imgOneW,s=t.imgJW,r=new Image;r.src=i[n].url,r.onload=function(){var a=r.width,g=r.height,h=t.imgOneW*g/a;i[n].height=h;var l=0,c=0;if(console.log("有进入获取图片信息"),t.isAdd){var m=e.imgList;i[0].top=e.winH/2-h/2,i[0].left=e.winW/2-o/2,i[0].width=o,i[0].height=h,i[0].zIndex=e.zIndexNum,i[0].angles=0,i[0].whRatio=o/h,m.push(i[0]),e.imgList=m}else{if(1==Math.ceil((n+1)/2))(n+1)%2==1&&(l=0,c=0),(n+1)%2==0&&(l=0,c=o+s),i[n].top=l,i[n].left=c,i[n].width=o,i[n].height=h,i[n].whRatio=o/h;else if(Math.ceil((n+1)/2)>1){for(var u=1;u<Math.ceil((n+1)/2);u++)(n+1)%2==1&&(l=l+i[2*u-1].height+s),(n+1)%2==0&&(l=l+i[2*u].height+s);(n+1)%2==1&&(c=0),(n+1)%2==0&&(c=o+s),i[n].top=l,i[n].left=c,i[n].width=o,i[n].height=h,i[n].whRatio=o/h}n>=i.length-1?e.imgList=i:e.getImgInfo({imgArr:i,curIndex:++n,imgOneW:o,imgJW:s,isAdd:!1})}}},startFn:function(t){var e=this,i=t.target.dataset.curindex;this.mergeBtnShow&&(this.mergeBtnShow=!1);var n={};if(n.point1={x:t.touches[0].pageX,y:t.touches[0].pageY},t.touches.length>1)n.point2={x:t.touches[1].pageX,y:t.touches[1].pageY},this.startPoint=n,this.$set(this.startPoint,this.startPoint,n);else{if(clearTimeout(this.delTimer),this.delNum+=1,2==this.delNum&&confirm("确定删除吗？")){var o,s=t.target.dataset.types;"img"==s?o=this.imgList:"text"==s&&(o=this.mergeTextArr),o.splice(i,1),"img"==s?this.imgList=o:"text"==s&&(this.mergeTextArr=o)}this.delTimer=setTimeout(function(){e.delNum=0},600),this.startPoint.point1=n.point1,this.$set(this.startPoint,this.startPoint.point1,n.point1)}this.moveTimer=setTimeout(function(){e.canMove=!0},1e3)},moveFn:function(t){this.czIndex=t.target.dataset.curindex;var e=t.target.dataset.types,i=t.target.dataset.curindex;if(1==t.touches.length){if(!this.canMove)return clearTimeout(this.moveTimer),!1;var n;"img"==e?n=this.imgList:"text"==e&&(n=this.mergeTextArr),n[i].left=t.touches[0].pageX-n[i].width/2,this.isApp?n[i].top=t.touches[0].pageY-n[i].height/2-api.safeArea.top:n[i].top=t.touches[0].pageY-n[i].height/2,n[i].zIndex!=this.zIndexNum&&(n[i].zIndex=++this.zIndexNum)}var o={};if(o.point1={x:t.touches[0].pageX,y:t.touches[0].pageY},t.touches.length>1){clearTimeout(this.moveTimer),o.point2={x:t.touches[1].pageX,y:t.touches[1].pageY},this.endPoint=o,this.$set(this.endPoint,this.endPoint,o);var s=this.startPoint,r=s.point1.x-s.point2.x,a=s.point1.y-s.point2.y,g=o.point1.x-o.point2.x,h=o.point1.y-o.point2.y,l=Math.abs(g)-Math.abs(r);l*=.2;var c=this.getAngle(h,g)-this.getAngle(a,r);if(this.imgScale=l,"img"==e){var m=this.imgList[i].width,u=this.imgList[i].left,d=this.imgList[i].top,p=this.imgList[i].whRatio;this.imgList[i].width=m+l,this.imgList[i].height=(m+l)/p,this.imgList[i].left=u-l/2,this.imgList[i].top=d-l/2,this.imgList[i].angles=c}else"text"==e&&(this.mergeTextArr[i].angles=c)}else this.endPoint.point1=o.point1,this.$set(this.endPoint,this.endPoint.point1,o.point1)},endFn:function(t){clearTimeout(this.moveTimer),this.canMove=!1,this.startPoint={point1:{x:0,y:0},point2:{x:0,y:0}},this.endPoint={point1:{x:0,y:0},point2:{x:0,y:0}}},getAngle:function(t,e){return 180*Math.atan2(t,e)/Math.PI},upimgs:function(t){var e=this.getObjectURL(t.target.files[0]);this.imgUrl=e},getObjectURL:function(t){var e=null;return void 0!=window.createObjectURL?e=window.createObjectURL(t):void 0!=window.URL?e=window.URL.createObjectURL(t):void 0!=window.webkitURL&&(e=window.webkitURL.createObjectURL(t)),e},selectImgs:function(){if(!this.isApp)return!1;this.mergeBtnShow=!1;var t=this;api.require("UIAlbumBrowser").open({max:0==this.imgList.length?6:1,type:"image",styles:{bg:"#fff",mark:{icon:"",position:"bottom_left",size:20},nav:{bg:"rgba(0,0,0,0.6)",titleColor:"#fff",titleSize:18,cancelColor:"#fff",cancelSize:16,finishColor:"#fff",finishSize:16}}},function(e){if(e){var i=[],n=Math.floor((window.innerWidth-40)/2);if(0==t.imgList.length){for(var o=0;o<e.list.length;o++){var s={url:e.list[o].path,top:0,left:0,width:0,height:0,zIndex:1,angles:0};i.push(s)}t.getImgInfo({imgArr:i,curIndex:0,imgOneW:n,imgJW:40,isAdd:0!=t.imgList.length})}else{s={url:e.list[0].path,top:0,left:0,width:0,height:0,zIndex:1,angles:0};i.push(s),t.getImgInfo({imgArr:i,curIndex:0,imgOneW:n,imgJW:40,isAdd:!0})}}})},setBgColor:function(t){this.bgType="color",this.bgColor="transparent"==t?null:t,this.bgShow=!1},selectBgColor:function(t){this.bgType="color",this.bgColor=t.target.value,this.bgShow=!1},setBgImg:function(){if(!this.isApp)return!1;var t=this;api.require("UIAlbumBrowser").open({max:1,type:"image",styles:{bg:"#fff",mark:{icon:"",position:"bottom_left",size:20},nav:{bg:"rgba(0,0,0,0.6)",titleColor:"#fff",titleSize:18,cancelColor:"#fff",cancelSize:16,finishColor:"#fff",finishSize:16}}},function(e){e&&(t.bgType="img",t.bgColor=e.list[0].path,t.bgShow=!1)})},clearAll:function(){if(confirm("确定清空所有？")){var t=document.getElementById("mergeImg").getContext("2d"),e=window.devicePixelRatio,i=window.innerWidth,n=this.winH;t.beginPath(),t.clearRect(0,0,i*e,n*e),t.restore(),t.save(),this.imgList=[],this.mergeBtnShow=!1,this.bgColor=null,this.bgType="color",this.czIndex=-1,this.zIndexNum=2,this.canvasImgSrc="",this.mergeTextArr=[],this.mergeFColor="black"}},createImg:function(){if(this.isCreateImg)return!1;this.isCreateImg=!0,this.mergeBtnShow=!1;var t=this,e=document.getElementById("mergeImg"),i=e.getContext("2d"),n=window.innerWidth,o=this.winH,s=window.devicePixelRatio;e.width=n*s,e.height=o*s;for(var r,a=this.imgList,g=0;g<a.length;g++)for(var h=g;h<a.length;h++)a[g].zIndex>a[h].zIndex&&(r=a[h],a[h]=a[g],a[g]=r);if("color"==this.bgType)this.bgColor?(i.beginPath(),i.fillStyle=this.bgColor,i.fillRect(0,0,n*s,o*s),i.save(),c(a,0)):setTimeout(function(){c(a,0)},300);else if("img"==this.bgType){var l=new Image;l.src=this.bgColor,l.onload=function(){i.beginPath(),i.drawImage(l,0,0,n*s,o*s),i.save(),c(a,0)}}function c(e,n){var o=new Image;o.src=e[n].url,o.onload=function(){i.save(),i.beginPath(),0!=e[n].angles?(i.translate(e[n].left*s+e[n].width*s/2,e[n].top*s+e[n].height*s/2),i.rotate(e[n].angles*Math.PI/180),i.drawImage(o,-e[n].width*s/2,-e[n].height*s/2,e[n].width*s,e[n].height*s),i.restore()):(i.drawImage(o,e[n].left*s,e[n].top*s,e[n].width*s,e[n].height*s),i.restore()),n<e.length-1?setTimeout(function(){c(e,++n)},300):t.mergeTextArr.length>0?function t(e,n){i.save();i.font=e[n].fSize*s+"px 微软雅黑";i.fillStyle=e[n].color;i.textBaseline="middle";0!=e[n].angles?(i.translate(e[n].left*s+e[n].width*s/2,e[n].top*s+e[n].height*s/2),i.rotate(e[n].angles*Math.PI/180),i.fillText(e[n].text,-e[n].width*s/2,-e[n].height*s/2)):i.fillText(e[n].text,e[n].left*s,e[n].top*s);i.restore();n<e.length-1?setTimeout(function(){t(e,++n)},300):m()}(t.mergeTextArr,0):m()}}function m(){setTimeout(function(){var i=new Image;i.setAttribute("crossOrigin","Anonymous");var n=e.toDataURL("image/png");i.src=n,t.canvasImgSrc=n,t.showCanvasImg=!0,t.isCreateImg=!1},500)}},saveCanvasImg:function(){this.showCanvasImg=!1,this.commonFn.saveImgsToAlbum({type:"base64",hasbs64:!0,istip:!1,curData:this.canvasImgSrc}).then(function(){})},cancelCanvasImg:function(){this.showCanvasImg=!1,this.canvasImgSrc=""},addFonts:function(){this.fontShow=!this.fontShow,this.mergeBtnShow=!1},closeFontShow:function(){this.fontShow=!1,this.mergeText="",this.mergeFSize="",this.mergeFColor="black"},saveFont:function(){var t=this,e=this.mergeTextArr,i={text:this.mergeText,width:0,height:0,top:0,left:0,zIndex:this.zIndexNum,color:this.mergeFColor,fSize:this.mergeFSize,angles:0,opacity:0};e.push(i),this.mergeTextArr=e,setTimeout(function(){var i=document.querySelectorAll(".mergeTexts")[e.length-1].getBoundingClientRect();t.mergeTextArr[e.length-1].width=i.width,t.mergeTextArr[e.length-1].height=i.height,t.mergeTextArr[e.length-1].top=t.winH/2-i.height/2,t.mergeTextArr[e.length-1].left=t.winW/2-i.width/2,t.mergeTextArr[e.length-1].opacity=1,t.fontShow=!1,t.mergeText="",t.mergeFSize="",t.mergeFColor="black"},300)}}},o={render:function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"mergeImg",style:"height:"+t.winH+"px;"+("color"==t.bgType?"background-color:"+(t.bgColor?t.bgColor:"transparent"):"background:url("+t.bgColor+") no-repeat center center/cover;")+";"},[n("div",{staticClass:"mergeImgBtn",class:t.mergeBtnShow?"active":""},[n("ul",[n("li",{on:{click:t.selectImgs}},[t._v("选择图片")]),t._v(" "),n("li",{on:{click:t.changeBgShow}},[t._v("选择背景")]),t._v(" "),n("li",{on:{click:t.addFonts}},[t._v("添加文字")]),t._v(" "),n("li",{on:{click:t.clearAll}},[t._v("清空")]),t._v(" "),n("li",{on:{click:t.createImg}},[t._v("生成图片")])]),t._v(" "),n("button",{attrs:{type:"button"},on:{click:t.changeBtnShow}},[n("img",{attrs:{src:i("p43W"),alt:""}})])]),t._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:t.bgShow,expression:"bgShow"}],staticClass:"mergeImgBgBox",class:t.bgShow?"active":""},[n("button",{attrs:{type:"botton"},on:{click:t.closeBgShow}},[n("img",{attrs:{src:i("xp5Z"),alt:""}})]),t._v(" "),n("ul",[n("li",{on:{click:function(e){return t.setBgColor("transparent")}}},[n("span",[t._v("透明背景(默认)")])]),t._v(" "),n("li",{on:{click:function(e){return t.setBgColor("white")}}},[n("span",[t._v("白色背景")])]),t._v(" "),n("li",{on:{click:function(e){return t.setBgColor("black")}}},[n("span",[t._v("黑色背景")])]),t._v(" "),n("li",[n("span",[t._v("选择颜色")]),n("input",{attrs:{type:"color"},on:{change:t.selectBgColor}})]),t._v(" "),n("li",{on:{click:t.setBgImg}},[n("span",[t._v("选择背景图")])])])]),t._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:t.fontShow,expression:"fontShow"}],staticClass:"mergeFontBox",class:t.fontShow?"active":""},[n("button",{attrs:{type:"botton"},on:{click:t.closeFontShow}},[n("img",{attrs:{src:i("xp5Z"),alt:""}})]),t._v(" "),n("ul",[n("li",[n("textarea",{directives:[{name:"model",rawName:"v-model",value:t.mergeText,expression:"mergeText"}],attrs:{name:"",placeholder:"输入内容"},domProps:{value:t.mergeText},on:{input:function(e){e.target.composing||(t.mergeText=e.target.value)}}})]),t._v(" "),n("li",[n("input",{directives:[{name:"model",rawName:"v-model",value:t.mergeFSize,expression:"mergeFSize"}],attrs:{type:"text",placeholder:"输入字体大小"},domProps:{value:t.mergeFSize},on:{input:function(e){e.target.composing||(t.mergeFSize=e.target.value)}}})]),t._v(" "),n("li",[n("input",{directives:[{name:"model",rawName:"v-model",value:t.mergeFColor,expression:"mergeFColor"}],attrs:{type:"color"},domProps:{value:t.mergeFColor},on:{input:function(e){e.target.composing||(t.mergeFColor=e.target.value)}}}),t._v(" "),n("span",[t._v("选择颜色")]),n("i",{style:"background-color:"+t.mergeFColor+";"})])]),t._v(" "),n("div",{staticClass:"mergeFBtn"},[n("button",{attrs:{type:"button"},on:{click:t.saveFont}},[t._v("确定")])])]),t._v(" "),n("div",{ref:"imgBox",staticClass:"imgBox"},t._l(t.imgList,function(e,i){return n("img",{staticClass:"imgurls",style:"width:"+e.width+"px;height:"+e.height+"px;top:"+e.top+"px;left:"+e.left+"px;z-index:"+e.zIndex+";transform:rotateZ("+e.angles+"deg);",attrs:{"data-curindex":i,"data-types":"img",src:e.url,alt:""},on:{touchstart:t.startFn,touchmove:t.moveFn,touchend:t.endFn}})}),0),t._v(" "),n("div",{staticClass:"showTextBox"},t._l(t.mergeTextArr,function(e,i){return n("span",{staticClass:"mergeTexts",style:"top:"+e.top+"px;left:"+e.left+"px;color:"+e.color+";font-size:"+e.fSize+"px;z-index:"+e.zIndex+";transform:rotateZ("+e.angles+"deg);opacity:"+e.opacity+";",attrs:{"data-curindex":i,"data-types":"text"},on:{touchstart:t.startFn,touchmove:t.moveFn,touchend:t.endFn}},[t._v(t._s(e.text))])}),0),t._v(" "),n("canvas",{style:"height:"+t.winH+"px;",attrs:{id:"mergeImg"}}),t._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:t.showCanvasImg,expression:"showCanvasImg"}],staticClass:"showCanvasImg"},[n("img",{attrs:{src:t.canvasImgSrc,alt:""}}),t._v(" "),n("div",[n("button",{attrs:{type:"button"},on:{click:t.cancelCanvasImg}},[t._v("取消")]),t._v(" "),n("button",{attrs:{type:"button"},on:{click:t.saveCanvasImg}},[t._v("保存")])])])])},staticRenderFns:[]};var s=i("VU/8")(n,o,!1,function(t){i("o0l4")},null,null);e.default=s.exports},o0l4:function(t,e){}});