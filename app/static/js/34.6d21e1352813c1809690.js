webpackJsonp([34],{Vq4v:function(t,e){},kP1p:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=i("mvHQ"),n=i.n(o),s={name:"merge_img",data:function(){return{winH:window.innerHeight,winW:window.innerWidth,startPoint:{point1:{x:0,y:0},point2:{x:0,y:0}},endPoint:{point1:{x:0,y:0},point2:{x:0,y:0}},imgList:[],mergeBtnShow:!1,bgShow:!1,canMove:!1,moveTimer:"",zIndexNum:2,imgScale:0,czIndex:-1,bgType:"color",bgColor:null,showCanvasImg:!1,canvasImgSrc:"",isCreateImg:!1,delTimer:"",delNum:0,fontShow:!1,mergeText:"",mergeFSize:"",mergeFColor:"black",mergeTextArr:[]}},mounted:function(){this.isApp?this.winH=window.innerHeight-api.safeArea.top:this.winH=window.innerHeight},methods:{changeBtnShow:function(){this.mergeBtnShow=!this.mergeBtnShow},changeBgShow:function(){this.bgShow=!this.bgShow,this.mergeBtnShow=!1},closeBgShow:function(){this.bgShow=!1},getImgInfo:function(t){var e=this,i=t.imgArr,o=t.curIndex,n=t.imgOneW,s=t.imgJW,r=new Image;r.src=i[o].url,r.onload=function(){var a=r.width,g=r.height,h=t.imgOneW*g/a;i[o].height=h;var l=0,c=0;if(1==Math.ceil((o+1)/2))(o+1)%2==1&&(l=0,c=0),(o+1)%2==0&&(l=0,c=n+s),i[o].top=l,i[o].left=c,i[o].width=n,i[o].height=h,i[o].whRatio=n/h;else if(Math.ceil((o+1)/2)>1){for(var m=1;m<Math.ceil((o+1)/2);m++)(o+1)%2==1&&(l=l+i[2*m-1].height+s),(o+1)%2==0&&(l=l+i[2*m].height+s);(o+1)%2==1&&(c=0),(o+1)%2==0&&(c=n+s),i[o].top=l,i[o].left=c,i[o].width=n,i[o].height=h,i[o].whRatio=n/h}o>=i.length-1?e.imgList=i:e.getImgInfo({imgArr:i,curIndex:++o,imgOneW:n,imgJW:s})}},startFn:function(t){var e=this,i=t.target.dataset.curindex;this.mergeBtnShow&&(this.mergeBtnShow=!1);var o={};if(o.point1={x:t.touches[0].pageX,y:t.touches[0].pageY},t.touches.length>1)o.point2={x:t.touches[1].pageX,y:t.touches[1].pageY},this.startPoint=o,this.$set(this.startPoint,this.startPoint,o);else{if(clearTimeout(this.delTimer),this.delNum+=1,2==this.delNum&&confirm("确定删除吗？")){var n,s=t.target.dataset.types;"img"==s?n=this.imgList:"text"==s&&(n=this.mergeTextArr),n.splice(i,1),"img"==s?this.imgList=n:"text"==s&&(this.mergeTextArr=n)}this.delTimer=setTimeout(function(){e.delNum=0},600),this.startPoint.point1=o.point1,this.$set(this.startPoint,this.startPoint.point1,o.point1)}this.moveTimer=setTimeout(function(){e.canMove=!0},1e3)},moveFn:function(t){this.czIndex=t.target.dataset.curindex;var e=t.target.dataset.types,i=t.target.dataset.curindex;if(1==t.touches.length){if(!this.canMove)return clearTimeout(this.moveTimer),!1;var o;"img"==e?o=this.imgList:"text"==e&&(o=this.mergeTextArr),o[i].left=t.touches[0].pageX-o[i].width/2,this.isApp?o[i].top=t.touches[0].pageY-o[i].height/2-api.safeArea.top:o[i].top=t.touches[0].pageY-o[i].height/2,o[i].zIndex!=this.zIndexNum&&(o[i].zIndex=++this.zIndexNum)}var n={};if(n.point1={x:t.touches[0].pageX,y:t.touches[0].pageY},t.touches.length>1){clearTimeout(this.moveTimer),n.point2={x:t.touches[1].pageX,y:t.touches[1].pageY},this.endPoint=n,this.$set(this.endPoint,this.endPoint,n);var s=this.startPoint,r=s.point1.x-s.point2.x,a=s.point1.y-s.point2.y,g=n.point1.x-n.point2.x,h=n.point1.y-n.point2.y,l=Math.abs(g)-Math.abs(r);l*=.2;var c=this.getAngle(h,g)-this.getAngle(a,r);if(this.imgScale=l,"img"==e){var m=this.imgList[i].width,u=this.imgList[i].left,v=this.imgList[i].top,p=this.imgList[i].whRatio;this.imgList[i].width=m+l,this.imgList[i].height=(m+l)/p,this.imgList[i].left=u-l/2,this.imgList[i].top=v-l/2,this.imgList[i].angles=c}else"text"==e&&(this.mergeTextArr[i].angles=c)}else this.endPoint.point1=n.point1,this.$set(this.endPoint,this.endPoint.point1,n.point1)},endFn:function(t){clearTimeout(this.moveTimer),this.canMove=!1,this.startPoint={point1:{x:0,y:0},point2:{x:0,y:0}},this.endPoint={point1:{x:0,y:0},point2:{x:0,y:0}}},getAngle:function(t,e){return 180*Math.atan2(t,e)/Math.PI},upimgs:function(t){console.log(t);var e=this.getObjectURL(t.target.files[0]);console.log(e),this.imgUrl=e},getObjectURL:function(t){var e=null;return void 0!=window.createObjectURL?e=window.createObjectURL(t):void 0!=window.URL?e=window.URL.createObjectURL(t):void 0!=window.webkitURL&&(e=window.webkitURL.createObjectURL(t)),e},selectImgs:function(){if(!this.isApp)return!1;this.mergeBtnShow=!1;var t=this;api.require("UIAlbumBrowser").open({max:6,type:"image",styles:{bg:"#fff",mark:{icon:"",position:"bottom_left",size:20},nav:{bg:"rgba(0,0,0,0.6)",titleColor:"#fff",titleSize:18,cancelColor:"#fff",cancelSize:16,finishColor:"#fff",finishSize:16}}},function(e){if(e){console.log(n()(e));for(var i=[],o=0;o<e.list.length;o++){var s={url:e.list[o].path,top:0,left:0,width:0,height:0,zIndex:1,angles:0};i.push(s)}var r=Math.floor((window.innerWidth-40)/2);t.getImgInfo({imgArr:i,curIndex:0,imgOneW:r,imgJW:40})}})},setBgColor:function(t){this.bgType="color",this.bgColor="transparent"==t?null:t,this.bgShow=!1},selectBgColor:function(t){console.log(t),this.bgType="color",this.bgColor=t.target.value,this.bgShow=!1},setBgImg:function(){if(!this.isApp)return!1;var t=this;api.require("UIAlbumBrowser").open({max:1,type:"image",styles:{bg:"#fff",mark:{icon:"",position:"bottom_left",size:20},nav:{bg:"rgba(0,0,0,0.6)",titleColor:"#fff",titleSize:18,cancelColor:"#fff",cancelSize:16,finishColor:"#fff",finishSize:16}}},function(e){e&&(console.log(n()(e)),t.bgType="img",t.bgColor=e.list[0].path,t.bgShow=!1)})},clearAll:function(){if(confirm("确定清空所有？")){var t=document.getElementById("mergeImg").getContext("2d"),e=window.devicePixelRatio,i=window.innerWidth,o=this.winH;t.beginPath(),t.clearRect(0,0,i*e,o*e),t.restore(),t.save(),this.imgList=[],this.mergeBtnShow=!1,this.bgColor=null,this.bgType="color",this.czIndex=-1,this.zIndexNum=2,this.canvasImgSrc="",this.mergeTextArr=[]}},createImg:function(){if(this.isCreateImg)return console.log("图片生成中！"),!1;this.isCreateImg=!0;var t=this,e=document.getElementById("mergeImg"),i=e.getContext("2d"),o=window.innerWidth,n=this.winH,s=window.devicePixelRatio;e.width=o*s,e.height=n*s;for(var r,a=this.imgList,g=0;g<a.length;g++)for(var h=g;h<a.length;h++)a[g].zIndex>a[h].zIndex&&(r=a[h],a[h]=a[g],a[g]=r);if("color"==this.bgType)this.bgColor?(i.beginPath(),i.fillStyle=this.bgColor,i.fillRect(0,0,o*s,n*s),i.save(),c(a,0)):setTimeout(function(){c(a,0)},300);else if("img"==this.bgType){var l=new Image;l.src=this.bgColor,l.onload=function(){i.beginPath(),i.drawImage(l,0,0,o*s,n*s),i.save(),c(a,0)}}function c(e,o){console.log(o);var n=new Image;n.src=e[o].url,n.onload=function(){i.save(),i.beginPath(),0!=e[o].angles?(i.translate(e[o].left*s+e[o].width*s/2,e[o].top*s+e[o].height*s/2),console.log("旋转角度："+e[o].angles),i.rotate(e[o].angles*Math.PI/180),i.drawImage(n,-e[o].width*s/2,-e[o].height*s/2,e[o].width*s,e[o].height*s),i.restore()):(i.drawImage(n,e[o].left*s,e[o].top*s,e[o].width*s,e[o].height*s),i.restore()),o<e.length-1?setTimeout(function(){c(e,++o)},300):t.mergeTextArr.length>0?function t(e,o){i.save();i.font=e[o].fSize*s+"px 微软雅黑";i.fillStyle=e[o].color;0!=e[o].angles?(i.translate(e[o].left*s+e[o].width*s/2,e[o].top*s+e[o].height*s/2),console.log("旋转角度："+e[o].angles),i.rotate(e[o].angles*Math.PI/180),i.fillText(e[o].text,-e[o].width*s/2,-e[o].height*s/2)):i.fillText(e[o].text,e[o].left*s,e[o].top*s);i.restore();o<e.length-1?setTimeout(function(){t(e,++o)},300):m()}(t.mergeTextArr,0):m()}}function m(){setTimeout(function(){console.log("执行生成图片");var i=new Image;i.setAttribute("crossOrigin","Anonymous");var o=e.toDataURL("image/png");i.src=o,t.canvasImgSrc=o,t.showCanvasImg=!0,t.isCreateImg=!1},500)}},saveCanvasImg:function(){this.showCanvasImg=!1,this.commonFn.saveImgsToAlbum({type:"base64",hasbs64:!0,istip:!1,curData:this.canvasImgSrc}).then(function(){})},cancelCanvasImg:function(){this.showCanvasImg=!1,this.canvasImgSrc=""},addFonts:function(){this.fontShow=!this.fontShow,this.mergeBtnShow=!1},closeFontShow:function(){this.fontShow=!1,this.mergeText="",this.mergeFSize="",this.mergeFColor=""},saveFont:function(){var t=this;console.log(this.mergeText),console.log(this.mergeFSize),console.log(this.mergeFColor);var e=this.mergeTextArr,i={text:this.mergeText,width:0,height:0,top:0,left:0,zIndex:1,color:this.mergeFColor,fSize:this.mergeFSize,angles:0,opacity:0};e.push(i),this.mergeTextArr=e,setTimeout(function(){var i=document.querySelectorAll(".mergeTexts")[e.length-1].getBoundingClientRect();t.mergeTextArr[e.length-1].width=i.width,t.mergeTextArr[e.length-1].height=i.height,t.mergeTextArr[e.length-1].top=t.winH/2-i.height/2,t.mergeTextArr[e.length-1].left=t.winW/2-i.width/2,t.mergeTextArr[e.length-1].opacity=1,t.fontShow=!1,t.mergeText="",t.mergeFSize="",t.mergeFColor=""},300)}}},r={render:function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"mergeImg",style:"height:"+t.winH+"px;"+("color"==t.bgType?"background-color:"+(t.bgColor?t.bgColor:"transparent"):"background:url("+t.bgColor+") no-repeat center center/cover;")+";"},[o("div",{staticClass:"mergeImgBtn",class:t.mergeBtnShow?"active":""},[o("ul",[o("li",{on:{click:t.selectImgs}},[t._v("选择图片")]),t._v(" "),o("li",{on:{click:t.changeBgShow}},[t._v("选择背景")]),t._v(" "),o("li",{on:{click:t.addFonts}},[t._v("添加文字")]),t._v(" "),o("li",{on:{click:t.clearAll}},[t._v("清空")]),t._v(" "),o("li",{on:{click:t.createImg}},[t._v("生成图片")])]),t._v(" "),o("button",{attrs:{type:"button"},on:{click:t.changeBtnShow}},[o("img",{attrs:{src:i("p43W"),alt:""}})])]),t._v(" "),o("div",{directives:[{name:"show",rawName:"v-show",value:t.bgShow,expression:"bgShow"}],staticClass:"mergeImgBgBox",class:t.bgShow?"active":""},[o("button",{attrs:{type:"botton"},on:{click:t.closeBgShow}},[o("img",{attrs:{src:i("xp5Z"),alt:""}})]),t._v(" "),o("ul",[o("li",{on:{click:function(e){return t.setBgColor("transparent")}}},[o("span",[t._v("透明背景(默认)")])]),t._v(" "),o("li",{on:{click:function(e){return t.setBgColor("white")}}},[o("span",[t._v("白色背景")])]),t._v(" "),o("li",{on:{click:function(e){return t.setBgColor("black")}}},[o("span",[t._v("黑色背景")])]),t._v(" "),o("li",[o("span",[t._v("选择颜色")]),o("input",{attrs:{type:"color"},on:{change:t.selectBgColor}})]),t._v(" "),o("li",{on:{click:t.setBgImg}},[o("span",[t._v("选择背景图")])])])]),t._v(" "),o("div",{directives:[{name:"show",rawName:"v-show",value:t.fontShow,expression:"fontShow"}],staticClass:"mergeFontBox",class:t.fontShow?"active":""},[o("button",{attrs:{type:"botton"},on:{click:t.closeFontShow}},[o("img",{attrs:{src:i("xp5Z"),alt:""}})]),t._v(" "),o("ul",[o("li",[o("textarea",{directives:[{name:"model",rawName:"v-model",value:t.mergeText,expression:"mergeText"}],attrs:{name:"",placeholder:"输入内容"},domProps:{value:t.mergeText},on:{input:function(e){e.target.composing||(t.mergeText=e.target.value)}}})]),t._v(" "),o("li",[o("input",{directives:[{name:"model",rawName:"v-model",value:t.mergeFSize,expression:"mergeFSize"}],attrs:{type:"text",placeholder:"输入字体大小"},domProps:{value:t.mergeFSize},on:{input:function(e){e.target.composing||(t.mergeFSize=e.target.value)}}})]),t._v(" "),o("li",[o("input",{directives:[{name:"model",rawName:"v-model",value:t.mergeFColor,expression:"mergeFColor"}],attrs:{type:"color"},domProps:{value:t.mergeFColor},on:{input:function(e){e.target.composing||(t.mergeFColor=e.target.value)}}}),t._v(" "),o("span",[t._v("选择颜色")]),o("i",{style:"background-color:"+t.mergeFColor+";"})])]),t._v(" "),o("div",{staticClass:"mergeFBtn"},[o("button",{attrs:{type:"button"},on:{click:t.saveFont}},[t._v("确定")])])]),t._v(" "),o("div",{ref:"imgBox",staticClass:"imgBox"},t._l(t.imgList,function(e,i){return o("img",{staticClass:"imgurls",style:"width:"+e.width+"px;height:"+e.height+"px;top:"+e.top+"px;left:"+e.left+"px;z-index:"+e.zIndex+";transform:rotateZ("+e.angles+"deg);",attrs:{"data-curindex":i,"data-types":"img",src:e.url,alt:""},on:{touchstart:t.startFn,touchmove:t.moveFn,touchend:t.endFn}})}),0),t._v(" "),o("div",{staticClass:"showTextBox"},t._l(t.mergeTextArr,function(e,i){return o("span",{staticClass:"mergeTexts",style:"top:"+e.top+"px;left:"+e.left+"px;color:"+e.color+";font-size:"+e.fSize+"px;z-index:"+e.zIndex+";transform:rotateZ("+e.angles+"deg);opacity:"+e.opacity+";",attrs:{"data-curindex":i,"data-types":"text"},on:{touchstart:t.startFn,touchmove:t.moveFn,touchend:t.endFn}},[t._v(t._s(e.text))])}),0),t._v(" "),o("canvas",{style:"height:"+t.winH+"px;",attrs:{id:"mergeImg"}}),t._v(" "),o("div",{directives:[{name:"show",rawName:"v-show",value:t.showCanvasImg,expression:"showCanvasImg"}],staticClass:"showCanvasImg"},[o("img",{attrs:{src:t.canvasImgSrc,alt:""}}),t._v(" "),o("div",[o("button",{attrs:{type:"button"},on:{click:t.cancelCanvasImg}},[t._v("取消")]),t._v(" "),o("button",{attrs:{type:"button"},on:{click:t.saveCanvasImg}},[t._v("保存")])])])])},staticRenderFns:[]};var a=i("VU/8")(s,r,!1,function(t){i("Vq4v")},null,null);e.default=a.exports}});